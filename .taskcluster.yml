version: 1
reporting: checks-v1
autoCancelPreviousChecks: true
policy:
  pullRequests: public
tasks:
  $let:
    head_rev:
      $if: 'tasks_for == "github-pull-request"'
      then: ${event.pull_request.head.sha}
      else: ${event.after}
    repository:
      $if: 'tasks_for == "github-pull-request"'
      then: ${event.pull_request.head.repo.html_url}
      else: ${event.repository.html_url}
  in:
    $match:
      (tasks_for == "github-pull-request" && event["action"] in ["opened", "synchronize"]) || (tasks_for == "github-push" && event["ref"] == "refs/heads/main"):
        provisionerId: "proj-taskcluster"
        workerType: "ci"
        created: { $fromNow: "" }
        deadline: { $fromNow: "1 hour" }
        scopes:
          # it's OK that this secret is accessible in PRs
          - secrets:get:project/taskcluster/testing/azure
        payload:
          maxRunTime: 3600
          image: node:20.17
          features:
            taskclusterProxy: true
          command:
            - /bin/bash
            - "--login"
            - "-c"
            - >-
              git clone ${repository} repo &&
              cd repo &&
              git config advice.detachedHead false &&
              git checkout ${head_rev} &&
              yarn &&
              yarn test &&
              yarn docs # ensure docs build
        metadata:
          name: test
          description: Tests for fast-azure-storage
          owner: nobody@mozilla.com
          source: https://github.com/taskcluster/fast-azure-storage
